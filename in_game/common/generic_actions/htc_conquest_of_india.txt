htc_coi_purchase_province = {
    type = situation
    show_message = no
    potential = {
        scope:actor = {
            capital ?= { continent = continent:europe }
        }
    }

    allow = {
        scope:actor = {
            at_war = no
        }
    }

    automation_tick = never
    automation_tick_frequency = 12
    ai_tick = monthly
    ai_tick_frequency = 6

    cooldown = {
        type = htc_coi_purchase_province_key
        years = 2
    }

    select_trigger = {
        looking_for_a = situation
        interaction_source_list = {
            situation:conquest_of_india = {
                add_to_list = source
            }
        }
        target_flag = recipient
        name = "choose_situation"
        column = {
            data = name
        }
        visible = {
            situation:conquest_of_india = this
            situation_is_active = yes
            # var:strongest_european_power = scope:actor
        }
    }

    select_trigger = {
        looking_for_a = province
        target_flag = target
        name = "choose_province"
        none_available_msg_key = "no_provinces_available"
        column = { data = owner_flag }
        column = { data = name }
        column = { data = population }
        visible = {
            # is in indian subcontinent
            sub_continent = sub_continent:south_asia
            # is adjacent or coastal to owned
            any_location_in_province = {
                or = {
                    adjacent_to_owned_or_owned_by_subject = scope:actor
                    is_coastal = yes 
                }
            }
        }
        enabled = {
            or = {
                # owner is indian
                root.owner.culture = { has_culture_group = culture_group:indian_group }
                # we are the strongest european
                custom_tooltip = {
                    text = htc_coi_we_are_strongest_european_tt
                    scope:actor = situation:conquest_of_india.var:strongest_european_power
                }
            }
            # province has low control and low satisfaction
            province_average_control < 0.5
            or = {
                province_satisfaction < 0.5
                province_food_percentage < 0.5
            }
        }
    }
    effect = {
        if = {
            limit = { exists = scope:target }
            scope:actor = {
                add_gold = {
                    value = 100
                    scope:target = {
                        every_location_in_province = {
                            add = development
                            multiply = 2
                        }
                    }
                    max = {
                        value = scope:target.owner.country_tax_base
                        multiply = 5
                    }
                    multiply = -1
                }
            }
            scope:target.owner = {
                add_gold = {
                    value = 100
                    scope:target = {
                        every_location_in_province = {
                            add = development
                            multiply = 2
                        }
                    }
                    max = {
                        value = scope:target.owner.country_tax_base
                        multiply = 5
                    }
                }
            }
        }
        else = {
            custom_tooltip = {
                text = htc_coi_purchase_province_effect_tt
            }
        }
        scope:target = {
            every_location_in_province = {
                change_location_owner = scope:actor
            }
            # custom_tooltip = {
            #     text = htc_coi_purchase_province_tt
            #     scope:target = {
            #         trigger_event_non_silently = htc_conquest_of_india.4
            #     }
            # }
        }
    }

    ai_will_do = {
        value = -1
        if = {
            # has more than twice the gold required to purchase
            limit = {
                scope:actor = {    
                    gold > {
                        value = 100
                        scope:target = {
                            every_location_in_province = {
                                add = development
                                multiply = 2
                            }
                        }
                        max = {
                            value = scope:target.owner.country_tax_base
                            multiply = 5
                        }
                        multiply = 2
                    }
                }
            }
            add = scope:actor.societal_value:land_vs_naval
            add = {
                value = {
                    add =  scope:actor.societal_value:outward_vs_inward
                    multiply = -1
                }
            }
            if = {
                limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
                add = scope:actor.modifier:bias_for_colonialist_policies
            }
            if = {
                limit = {
                    scope:target = {
                        not = {
                            any_location_in_province = {
                                adjacent_to_owned_or_owned_by_subject = scope:actor
                            }
                        }
                    }
                }
                add = -200
            }
			every_subject_or_below = {
				limit = { is_subject_type = colonial_nation }
			}
        }
    }
}

htc_coi_offer_protection = {
    type = situation
    show_message = no
    potential = {
        scope:actor = {
            capital ?= { continent = continent:europe }
        }
    }

    allow = {
        scope:actor = {
            at_war = no
        }
    }

    automation_tick = never
    automation_tick_frequency = 12
    ai_tick = monthly
    ai_tick_frequency = 6

    cooldown = {
        type = htc_coi_offer_protection_key
        years = 1
    }

    select_trigger = {
        looking_for_a = situation
        interaction_source_list = {
            situation:conquest_of_india = {
                add_to_list = source
            }
        }
        target_flag = recipient
        name = "choose_situation"
        column = {
            data = name
        }
        visible = {
            situation:conquest_of_india = this
            situation_is_active = yes
            # var:strongest_european_power = scope:actor
        }
    }

    select_trigger = {
        looking_for_a = country
        target_flag = target
        name = "choose_country"
        column = { data = name }
        column = { data = great_power_score }
        column = { data = population }
        visible = {
            culture = { has_culture_group = culture_group:indian_group }
            or = {
                # is independent and we are more than twice as powerful
                and = {
                    is_subject = no
                    country_strength <= {
                        value = scope:actor.country_strength
                        divide = 2
                    }
                }
                # is a subject but we are more than three times as powerful as their top overlord
                and = {
                    is_subject = yes
                    top_overlord ?= {
                        country_strength < {
                            value = scope:actor.country_strength
                            divide = 3
                        }
                    }
                }
            }
        }
        enabled = {
            any_neighbor_country = {
                has_casus_belli_on = prev
            }
        }
    }

    effect = {
        if = {
            limit = { exists = scope:target }
            scope:actor = {
                add_gold = {
                    value = scope:target.country_tax_base
                    multiply = 10
                    multiply = -1
                }
            }
            scope:target = {
                add_gold = {
                    value = scope:target.country_tax_base
                    multiply = 10
                }
            }
            scope:target = {
                make_subject_of = {
                    target = scope:actor
                    type = subject_type:indian_vassal
                }   
            }
        }
        else = {
            custom_tooltip = {
                text = htc_coi_offer_protection_effect_tt
            }
        }
        # custom_tooltip = {
        #     text = htc_coi_offer_protection_tt
        #     scope:target = {
        #         trigger_event_non_silently = htc_conquest_of_india.5
        #     }
        # }
    }

    ai_will_do = {
        value = -1
        if = {
            limit = {
                scope:actor = {    
                    country_tax_base > {
                        value = scope:target.country_tax_base
                        multiply = 10
                    }
                }
            }
            add = scope:actor.societal_value:land_vs_naval
            add = {
                value = {
                    add = scope:actor.societal_value:outward_vs_inward
                    multiply = -1
                }
            }
            if = {
                limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
                add = scope:actor.modifier:bias_for_colonialist_policies
            }
            if = {
                limit = {
                    scope:target = {
                        not = { is_neighbor_of = scope:actor }
                    }
                }
                add = -200
            }
        }
    }
}

htc_coi_assist_in_war_for_vassal = {
    type = situation
    show_message = no
    potential = {
        scope:actor = {
            capital ?= { continent = continent:europe }
        }
    }

    allow = {
        scope:actor = {
            at_war = no
        }
    }

    automation_tick = never
    automation_tick_frequency = 12
    ai_tick = monthly
    ai_tick_frequency = 6

    cooldown = {
        type = htc_coi_assist_in_war_for_vassal_key
        months = 6
    }

    select_trigger = {
        looking_for_a = situation
        interaction_source_list = {
            situation:conquest_of_india = {
                add_to_list = source
            }
        }
        target_flag = recipient
        name = "choose_situation"
        column = {
            data = name
        }
        visible = {
            situation:conquest_of_india = this
            situation_is_active = yes
            # var:strongest_european_power = scope:actor
        }
    }

    select_trigger = {
        looking_for_a = country
        target_flag = target
        name = "choose_country"
        column = { data = name }
        column = { data = great_power_score }
        column = { data = population }
        visible = {
            culture = { has_culture_group = culture_group:indian_group }
            is_at_war = yes
            is_subject = no
            country_strength <= {
                value = scope:actor.country_strength
                divide = 2
            }
        }
        enabled = {
            is_in_losing_war = yes
            manpower_percentage <= 0.2
        }
    }
    
    effect = {
        if = {
            limit = { exists = scope:target }
            scope:actor = {
                add_manpower = {
                    value = scope:actor.monthly_manpower
                    multiply = -10
                }
            }
            scope:target = {
                add_manpower = {
                    value = scope:actor.monthly_manpower
                    multiply = 10
                }
            }
            scope:target = {
                make_subject_of = {
                    target = scope:actor
                    type = subject_type:indian_vassal
                }
            }
        }
        else = {
            custom_tooltip = {
                text = htc_coi_assist_in_war_for_vassal_effect_tt
            }
        }
        # custom_tooltip = {
        #     text = htc_coi_assist_in_war_for_vassal_tt
        #     scope:target = {
        #         trigger_event_non_silently = htc_conquest_of_india.6
        #     }
        # }
    }

    ai_will_do = {
        value = -1
        if = {
            limit = {
                scope:actor = {    
                    manpower_percentage >= 0.5
                }
            }
            add = scope:actor.country_strength
            add = {
                value = {
                    add = scope:actor.societal_value:outward_vs_inward
                    multiply = -1
                }
            }
            if = {
                limit = { scope:actor.modifier:bias_for_colonialist_policies > 0 }
                add = scope:actor.modifier:bias_for_colonialist_policies
            }
            if = {
                limit = {
                    scope:target = {
                        not = { is_neighbor_of = scope:actor }
                    }
                }
                add = -200
            }
        }
    }
}